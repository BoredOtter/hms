<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Keycloak Single-Page Application Example</title>
  </head>
  <body>
    <div id="user" style="display: none;">
      <button id="logout" type="button">Logout</button>
      <button id="showMyAccount" type="button">My Account</button>
      <button id="showIdToken" type="button">Show ID Token</button>
      <button id="showAccessToken" type="button">Show Access Token</button>
      <button id="refreshToken" type="button">Refresh</button>
      <button id="checkTokenValidity" type="button">Check Token Validity</button>
      <button id="testRequestwithToken" type="button">Test request with token</button>
      <button id="testRequestToService" type="button">Test request to serivce</button>
      <hr>
      <h2 id="name"></h2>
      <p><strong>User ID:</strong> <span id="userId"></span></p>
      <pre id="output"></pre>
      <hr>
      <h2>Get Users</h2>
      <button id="getUsers" type="button">Get Users</button>
      <pre id="usersOutput"></pre>
    </div>
    <script src="KC_URL/js/keycloak.js"></script>
    <script type="module">

      console.log("Scripts loading...");

      const outputElement = document.getElementById("output");
      const nameElement = document.getElementById("name");
      const userIdElement = document.getElementById("userId");
      const userElement = document.getElementById("user");
      const usersOutputElement = document.getElementById("usersOutput");

      function output(content) {
        if (typeof content === "object") {
          content = JSON.stringify(content, null, 2);
        }

        outputElement.textContent = content;
      }

      function showProfile() {
        const name =
          keycloak.idTokenParsed.name ||
          keycloak.idTokenParsed.preferred_username;
        const userId = keycloak.idTokenParsed.sub;

        nameElement.textContent = `Hello ${name}`;
        userIdElement.textContent = userId;
        userElement.style.display = "block";
      }

      document.getElementById("logout").addEventListener("click", () => {
        keycloak.logout();
      });

      document.getElementById("showIdToken").addEventListener("click", () => {
        output(keycloak.idTokenParsed);
      });

      document
        .getElementById("showAccessToken")
        .addEventListener("click", () => {
          output(keycloak.tokenParsed);
        });

      document
        .getElementById("refreshToken")
        .addEventListener("click", async () => {
          await keycloak.updateToken(-1);
          output(keycloak.idTokenParsed);
          showProfile();
        });

      document
        .getElementById("showMyAccount")
        .addEventListener("click", async () => {
          await keycloak.accountManagement();
        });
      document
        .getElementById("testRequestwithToken")
        .addEventListener("click", async () => {
          const response = await fetch("https://hms.test/api/v1/health", {
            headers: {
              Authorization: `Bearer ${keycloak.token}`,
            },
          });
          const data = await response.json();
          usersOutputElement.textContent = JSON.stringify(data, null, 2);
        });

        document
        .getElementById("testRequestToService")
        .addEventListener("click", async () => {
          const response = await fetch("https://hms.test/api/v1/validator", {
            headers: {
              Authorization: `Bearer ${keycloak.token}`,
            },
          });
          const data = await response.json();
          usersOutputElement.textContent = JSON.stringify(data, null, 2);
        });

      document
        .getElementById("checkTokenValidity")
        .addEventListener("click", async () => {
          const isTokenValid = keycloak.token !== null && !keycloak.isTokenExpired();
          output({ "Token Validity": isTokenValid });
        });

        function logoutOnTokenExpired() {
          console.log("Setting up token expiration handler.");
          if (keycloak.tokenParsed.exp) {
            const currentTime = Math.floor(new Date().getTime() / 1000);
            const remainingTime = keycloak.tokenParsed.exp - currentTime;
            console.log(`Token expires in ${remainingTime} seconds.`);
            setTimeout(() => {
              console.log("Token expired. Logging out.");
              keycloak.logout();
            }, remainingTime * 1000);
          } else {
            console.log("Token expiration time not found.");
          }
          console.log("Token expiration handler set up.");
        }

        function logRemainingTime() {
          const currentTime = Math.floor(new Date().getTime() / 1000);
          const remainingTime = keycloak.tokenParsed.exp - currentTime;
          console.log(`Remaining time before logout: ${remainingTime} seconds.`);
        }

        const keycloak = new Keycloak();
        keycloak.init({ onLoad: "login-required" }).then(() => {
          console.log("Keycloak initialized.");
          showProfile();
          logoutOnTokenExpired();
          setInterval(logRemainingTime, 1000); // Call logRemainingTime every 5 seconds
        }).catch((error) => {
          console.error("Error initializing Keycloak: ", error);
        });

        console.log("Scripts loaded.");
    </script>
  </body>
</html>
